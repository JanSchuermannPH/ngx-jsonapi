!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("rxjs/util/noop"),require("rxjs/add/operator/toPromise"),require("rxjs/add/operator/map"),require("localforage"),require("rxjs/util/isFunction"),require("rxjs/util/isArray"),require("rxjs/Subject"),require("rxjs/BehaviorSubject"),require("rxjs/util/isObject")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","@angular/common/http","rxjs/util/noop","rxjs/add/operator/toPromise","rxjs/add/operator/map","localforage","rxjs/util/isFunction","rxjs/util/isArray","rxjs/Subject","rxjs/BehaviorSubject","rxjs/util/isObject"],t):t(e["ngx-jsonapi"]={},e.ng.core,e.common,e.http,e.noop,null,null,e.localforage,e.isFunction,e.isArray,e.Subject,e.BehaviorSubject,e.isObject)}(this,function(e,t,r,u,h,i,n,o,c,l,a,f,s){"use strict";var p,d=(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}p(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),v=function(r,i){var n,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(s=o[2&t[0]?"return":t[0]?"throw":"next"])&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[0,s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(r,a)}catch(e){t=[6,e],o=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},y=function(){this.number=0,this.total_resources=0,this.resources_per_page=0},m=function(){function e(){}return e.newCollection=function(){return Object.defineProperties({},{$length:{get:function(){return 1*Object.keys(this).length},enumerable:!1},$toArray:{get:function(){var t=this;return Object.keys(this).map(function(e){return t[e]})},enumerable:!1},$is_loading:{value:!1,enumerable:!1,writable:!0},$source:{value:"",enumerable:!1,writable:!0},$cache_last_update:{value:0,enumerable:!1,writable:!0},page:{value:new y,enumerable:!1,writable:!0}})},e.isObjectLive=function(e,t){return 0<=e&&Date.now()<=t+1e3*e},e.forEach=function(t,r){Object.keys(t).forEach(function(e){r(t[e],e)})},e}();m.Params={id:"",include:[]},m.Schema={relationships:{},ttl:0};var g=function(){this.url="http://yourdomain/api/v1/",this.params_separator="?",this.unify_concurrency=!0,this.cache_prerequests=!0,this.cachestore_support=!0,this.parameters={page:{number:"page[number]",size:"page[size]"}}},_=function(){var r=this;this.promise=new Promise(function(e,t){r.resolve=e,r.reject=t})},b=function(o,s,a,c){return new(a||(a=Promise))(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},S=function(){function e(){this.calls={}}return e.prototype.hasPromises=function(e){return e in this.calls},e.prototype.getAPromise=function(r){return b(this,void 0,void 0,function(){var t;return v(this,function(e){return r in this.calls||(this.calls[r]=[]),t=new _,this.calls[r].push(t),[2,t.promise]})})},e.prototype.setPromiseRequest=function(n,t){return b(this,void 0,void 0,function(){var i=this;return v(this,function(e){return t.then(function(e){if(n in i.calls){for(var t=0,r=i.calls[n];t<r.length;t++){r[t].resolve(e)}delete i.calls[n]}}).catch(function(e){if(n in i.calls){for(var t=0,r=i.calls[n];t<r.length;t++){r[t].reject(e)}delete i.calls[n]}}),[2]})})},e}(),j=function(o,s,a,c){return new(a||(a=Promise))(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},w=function(){function e(e,t,r){this.http=e,this.rsJsonapiConfig=t,this.noDuplicatedHttpCallsService=r}return e.prototype.delete=function(t){return j(this,void 0,void 0,function(){return v(this,function(e){return[2,this.exec(t,"DELETE")]})})},e.prototype.get=function(t){return j(this,void 0,void 0,function(){return v(this,function(e){return[2,this.exec(t,"get")]})})},e.prototype.exec=function(o,s,a,c){return void 0===c&&(c=!0),j(this,void 0,void 0,function(){var t,r,i,n;return v(this,function(e){return t=null,"get"===s&&this.noDuplicatedHttpCallsService.hasPromises(o)||(r=new u.HttpRequest(s,this.rsJsonapiConfig.url+o,a||null,{headers:new u.HttpHeaders({"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"})}),i=this.http.request(r),"get"===s?this.noDuplicatedHttpCallsService.setPromiseRequest(o,i.toPromise()):t=i.toPromise()),null===t&&(t=this.noDuplicatedHttpCallsService.getAPromise(o)),n=new _,R.me.refreshLoadings(1),t.then(function(e){e=e.body||e,R.me.refreshLoadings(-1),n.resolve(e)}).catch(function(e){e=e.error||e,R.me.refreshLoadings(-1),e.status<=0?R.me.loadingsOffline(e)||console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsOffline for catch it) error =>",e):c&&!R.me.loadingsError(e)&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsError for catch it) error =>",e),n.reject(e)}),[2,n.promise]})})},e}();w.decorators=[{type:t.Injectable}],w.ctorParameters=function(){return[{type:u.HttpClient},{type:g},{type:S}]};var C=function(o,s,a,c){return new(a||(a=Promise))(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},O=function(){function e(){this.globalstore=o.createInstance({name:"jsonapiglobal"}),this.allstore=o.createInstance({name:"allstore"}),this.checkIfIsTimeToClean()}return e.prototype.checkIfIsTimeToClean=function(){var t=this;this.globalstore.getItem("_lastclean_time").then(function(e){Date.now()>=e.time+432e5&&(t.globalstore.setItem("_lastclean_time",{time:Date.now()}),t.checkAndDeleteOldElements())}).catch(function(){t.globalstore.setItem("_lastclean_time",{time:Date.now()})})},e.prototype.checkAndDeleteOldElements=function(){var r=this;this.allstore.keys().then(function(e){m.forEach(e,function(t){r.allstore.getItem(t).then(function(e){Date.now()>=e._lastupdate_time+864e5&&r.allstore.removeItem(t)}).catch(h.noop)})}).catch(h.noop)},e.prototype.getObjet=function(r){return C(this,void 0,void 0,function(){var t;return v(this,function(e){return t=new _,this.allstore.getItem("jsonapi."+r).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}),[2,t.promise]})})},e.prototype.getObjets=function(t){return C(this,void 0,void 0,function(){return v(this,function(e){return[2,this.allstore.getItem("jsonapi."+t[0])]})})},e.prototype.saveObject=function(e,t){t._lastupdate_time=Date.now(),this.allstore.setItem("jsonapi."+e,t)},e.prototype.clearCache=function(){this.allstore.clear(),this.globalstore.clear()},e.prototype.deprecateObjectsWithKey=function(r){var i=this;this.allstore.keys().then(function(e){m.forEach(e,function(t){t.startsWith(r)&&i.allstore.getItem(t).then(function(e){e._lastupdate_time=0,i.allstore.setItem(t,e)}).catch(h.noop)})}).catch(h.noop)},e}();var R=function(){function n(e,t,r){for(var i in this.resourceServices={},this.loadingsCounter=0,this.loadingsStart=h.noop,this.loadingsDone=h.noop,this.loadingsError=h.noop,this.loadingsOffline=h.noop,this.config=new g,this.config)this.config[i]=(this.config[i],this.config[i]);n.me=this,n.injectedServices={JsonapiStoreService:t,JsonapiHttp:r,rsJsonapiConfig:this.config}}return n.prototype.registerService=function(e){return!(e.type in this.resourceServices)&&(this.resourceServices[e.type]=e)},n.prototype.getResourceService=function(e){return this.resourceServices[e]},n.prototype.refreshLoadings=function(e){this.loadingsCounter+=e,0===this.loadingsCounter?this.loadingsDone():1===this.loadingsCounter&&this.loadingsStart()},n.prototype.clearCache=function(){return n.injectedServices.JsonapiStoreService.clearCache(),!0},n.prototype.duplicateResource=function(e){for(var r=this,i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];var n,o,s=this.getResourceService(e.type).new();return s.attributes=Object.assign({},s.attributes,e.attributes),n=e.relationships,o=function(t,e){"id"in e.data?-1<i.indexOf(t)?s.addRelationship(r.duplicateResource(e.data),t):s.addRelationship(e.data,t):-1<i.indexOf(t)?m.forEach(e.data,function(e){s.addRelationship(r.duplicateResource(e),t)}):s.addRelationships(e.data,t)},Object.keys(n).forEach(function(e){o(e,n[e])}),s},n}();R.decorators=[{type:t.Injectable}],R.ctorParameters=function(){return[{type:g,decorators:[{type:t.Optional}]},{type:O},{type:w}]};var x=function(){function t(e,t){if(e)throw new Error("NgxJsonapiModule is already loaded. Import it in the AppModule only")}return t.forRoot=function(e){return{ngModule:t,providers:[{provide:g,useValue:e}]}},t}();x.decorators=[{type:t.NgModule,args:[{imports:[r.CommonModule],exports:[u.HttpClientModule],providers:[R,S,O,w]}]}],x.ctorParameters=function(){return[{type:x,decorators:[{type:t.Optional},{type:t.SkipSelf}]},{type:R}]};var P=function(){function e(){}return e.prototype.proccess_exec_params=function(e){return c.isFunction(e.params)?(e.fc_error=e.fc_success,e.fc_success=e.params,e.params=Object.assign({},m.Params)):void 0===e.params?e.params=Object.assign({},m.Params):e.params=Object.assign({},m.Params,e.params),e.fc_success=c.isFunction(e.fc_success)?e.fc_success:h.noop,e.fc_error=c.isFunction(e.fc_error)?e.fc_error:void 0,e},e.prototype.runFc=function(e,t){return c.isFunction(e)?e(t):h.noop()},e}(),E=function(){function e(){this.paths=[],this.includes=[],this.get_params=[]}return e.prototype.applyParams=function(e,t){void 0===t&&(t={}),this.appendPath(e.getPrePath()),t.beforepath&&this.appendPath(t.beforepath),this.appendPath(e.getPath()),t.include&&this.setInclude(t.include)},e.prototype.appendPath=function(e){""!==e&&this.paths.push(e)},e.prototype.addParam=function(e){this.get_params.push(e)},e.prototype.setInclude=function(e){this.includes=e},e.prototype.getForCache=function(){return this.paths.join("/")+this.get_params.join("/")},e.prototype.get=function(){var e=this.get_params.slice();return 0<this.includes.length&&e.push("include="+this.includes.join(",")),this.paths.join("/")+(0<e.length?R.injectedServices.rsJsonapiConfig.params_separator+e.join("&"):"")},e}(),F=function(){function e(e,t,r,i,n){this.getService=e,this.relationships_from=t,this.relationships_dest=r,this.included_resources=i,this.schema=n}return e.prototype.buildRelationships=function(){var r=this;m.forEach(this.relationships_from,function(e,t){!(t in r.relationships_dest)&&"data"in e&&(r.relationships_dest[t]={data:m.newCollection(),content:"collection"}),e.data&&(r.schema.relationships[t]&&r.schema.relationships[t].hasMany?r.__buildRelationshipHasMany(e,t):r.__buildRelationshipHasOne(e,t))})},e.prototype.__buildRelationshipHasMany=function(e,t){var r=e.data[0]?e.data[0].type:"";r=r||t,this.getService(r)?this.__buildRelationshipCollection(e,t):this.__buildRelationshipDataCollection(e,t)},e.prototype.__buildRelationshipDataCollection=function(e,t){this.relationships_dest[t]={data:e.data,content:"ids"}},e.prototype.__buildRelationshipCollection=function(e,r){var i=this;if(0!==e.data.length){var n=m.newCollection();this.relationships_dest[r].content="collection",m.forEach(e.data,function(e){var t=i.__buildRelationship(e,i.included_resources);!("attributes"in t)&&t.id in i.relationships_dest[r].data&&"attributes"in i.relationships_dest[r].data[t.id]?n[t.id]=i.relationships_dest[r].data[t.id]:n[t.id]=t,"attributes"in t||(i.relationships_dest[r].content="ids")});var t={};m.forEach(e.data,function(e){t[e.id]=!0}),m.forEach(this.relationships_dest[r].data,function(e){e.id in t||delete i.relationships_dest[e.id]}),this.relationships_dest[r].data=n}else this.relationships_dest[r]={data:m.newCollection(),content:"collection"}},e.prototype.__buildRelationshipHasOne=function(e,t){if("type"in e.data){if(null!=this.relationships_dest[t].data&&e.data.id===this.relationships_dest[t].data.id||(this.relationships_dest[t].data={}),!this.relationships_dest[t].data.attributes||this.relationships_dest[t].data.id!==e.data.id){var r=this.__buildRelationship(e.data,this.included_resources);this.relationships_dest[t].data=r}}else this.relationships_dest[t].data={}},e.prototype.__buildRelationship=function(e,t){if(e.type in t&&e.id in t[e.type])return t[e.type][e.id];var r=this.getService(e.type);return r&&e.id in r.cachememory.resources?r.cachememory.resources[e.id]:(r&&r.cachestore.getResource(e).catch(h.noop),e)},e}(),A=function(){function a(){}return a.json_array2resources_array=function(e,t){void 0===t&&(t={});for(var r=0,i=e;r<i.length;r++){var n=i[r],o=a.json2resource(n,!1);t[o.type+"_"+o.id]=o}},a.json_array2resources_array_by_type=function(e){var t={},r={};return a.json_array2resources_array(e,t),m.forEach(t,function(e){e.type in r||(r[e.type]={}),r[e.type][e.id]=e}),r},a.json2resource=function(e,t){if(a.getService(e.type))return a.procreate(e);console.warn("`"+e.type+"`","service not found on json2resource()");var r=new I;return r.id=e.id,r.type=e.type,r},a.getService=function(e){return R.me.getResourceService(e)},a.procreate=function(e){var t;return"type"in e&&"id"in e||console.error("Jsonapi Resource is not correct",e),(t=e.id in a.getService(e.type).cachememory.resources?a.getService(e.type).cachememory.resources[e.id]:a.getService(e.type).cachememory.getOrCreateResource(e.type,e.id)).attributes=e.attributes||{},t.is_new=!1,t},a.build=function(e,t){var r={};"included"in e&&(r=a.json_array2resources_array_by_type(e.included)),Array.isArray(e.data)?a._buildCollection(e,t,r):a._buildResource(e.data,t,r)},a._buildCollection=function(e,t,r){t.page&&e.meta&&(t.page.number=e.meta.page||1,t.page.resources_per_page=e.meta.resources_per_page||null,t.page.total_resources=e.meta.total_resources||null);for(var i={},n=0,o=e.data;n<o.length;n++){var s=o[n];s.id in t||(t[s.id]=a.getService(s.type).cachememory.getOrCreateResource(s.type,s.id)),a._buildResource(s,t[s.id],r),i[s.id]=s.id}m.forEach(t,function(e){e.id in i||delete t[e.id]})},a._buildResource=function(e,t,r){t.id=e.id||"",t.attributes=e.attributes||{},t.is_new=!1;var i=a.getService(e.type);t.relationships&&i&&(a.getService(e.type).parseFromServer(t.attributes),new F(a.getService,e.relationships||{},t.relationships,r,i.schema).buildRelationships())},a}(),J=function(o,s,a,c){return new(a||(a=Promise))(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},I=function(t){function e(){var e=t.apply(this,arguments)||this;return e.is_new=!0,e.is_loading=!1,e.is_saving=!1,e.id="",e.type="",e.attributes={},e.relationships={},e}return d(e,t),e.prototype.reset=function(){var i=this;this.id="",this.attributes={},this.relationships={},m.forEach(this.getService().schema.relationships,function(e,t){if(i.getService().schema.relationships[t].hasMany){var r={data:m.newCollection(),content:"collection"};i.relationships[t]=r}else{r={data:{},content:"none"};i.relationships[t]=r}}),this.is_new=!0},e.prototype.toObject=function(n){var o=this;n=Object.assign({},m.Params,n);var e,s={},a=[],c=[];m.forEach(this.relationships,function(e,i){if(o.getService().schema.relationships[i]&&o.getService().schema.relationships[i].hasMany)s[i]={data:[]},m.forEach(e.data,function(e){var t={id:e.id,type:e.type};s[i].data.push(t);var r=e.type+"_"+e.id;-1===c.indexOf(r)&&-1!==n.include.indexOf(i)&&(c.push(r),a.push(e.toObject({}).data))});else{var t=e.data;!("id"in e.data)&&0<Object.keys(e.data).length&&console.warn(i+" defined with hasMany:false, but I have a collection"),t.id&&t.type?s[i]={data:{id:t.id,type:t.type}}:s[i]={data:{}};var r=t.type+"_"+t.id;-1===c.indexOf(r)&&-1!==n.include.indexOf(t.type)&&(c.push(r),a.push(t.toObject({}).data))}}),this.getService()&&this.getService().parseToServer?(e=Object.assign({},this.attributes),this.getService().parseToServer(e)):e=this.attributes;var t={data:{type:this.type,id:this.id,attributes:e,relationships:s}};return 0<a.length&&(t.included=a),t},e.prototype.save=function(t,r,i){return J(this,void 0,void 0,function(){return v(this,function(e){return[2,this.__exec({id:null,params:t,fc_success:r,fc_error:i,exec_type:"save"})]})})},e.prototype.__exec=function(r){return J(this,void 0,void 0,function(){var t;return v(this,function(e){switch(t=this.proccess_exec_params(r),r.exec_type){case"save":return[2,this._save(t.params,r.fc_success,r.fc_error)]}return[2]})})},e.prototype._save=function(o,s,a){return J(this,void 0,void 0,function(){var n=this;return v(this,function(e){return[2,new Promise(function(r,t){if(!n.is_saving&&!n.is_loading){n.is_saving=!0;var e=n.toObject(o),i=new E;i.applyParams(n.getService(),o),n.id&&i.appendPath(n.id),R.injectedServices.JsonapiHttp.exec(i.get(),n.id?"PATCH":"POST",e,!c.isFunction(a)).then(function(e){if(n.is_saving=!1,n.id||(n.getService().cachememory.deprecateCollections(i.get()),n.getService().cachestore.deprecateCollections(i.get())),"id"in e.data)n.id=e.data.id,A.build(e,n);else if(l.isArray(e.data)){console.warn("Server return a collection when we save()",e.data);var t=n.getService().cachememory.getOrCreateCollection("justAnUpdate");A.build(e,t),m.forEach(t,function(e,t){var r=A.getService(e.type).cachememory.resources[e.id];A.getService(e.type).cachememory.setResource(e),A.getService(e.type).cachestore.setResource(e),r.id=r.id+"x"}),console.warn("Temporal collection for a resource_value update",t)}n.runFc(s,e),r(e)}).catch(function(e){n.is_saving=!1,n.runFc(a,"data"in e?e.data:e),t("data"in e?e.data:e)})}})]})})},e.prototype.addRelationship=function(e,t){var r=e.id;r||(r="new_"+Math.floor(1e5*Math.random())),(t=t||e.type)in this.relationships||(this.relationships[t]={data:{},content:"none"}),t in this.getService().schema.relationships&&this.getService().schema.relationships[t].hasMany?this.relationships[t].data[r]=e:this.relationships[t].data=e},e.prototype.addRelationships=function(t,r){var i=this;r in this.relationships?m.forEach(this.relationships[r].data,function(e){e.id in t||delete i.relationships[r].data[e.id]}):this.relationships[r]={data:{},content:"none"},m.forEach(t,function(e){i.relationships[r].data[e.id]=e})},e.prototype.addRelationshipsArray=function(e,t){var r=this;e.forEach(function(e){r.addRelationship(e,t||e.type)})},e.prototype.removeRelationship=function(e,t){if(!(e in this.relationships))return!1;if(!("data"in this.relationships[e]))return!1;if(e in this.getService().schema.relationships&&this.getService().schema.relationships[e].hasMany){if(!(t in this.relationships[e].data))return!1;delete this.relationships[e].data[t]}else this.relationships[e].data={};return!0},e.prototype.getService=function(){return A.getService(this.type)},e}(P),M=function(){function e(){}return e.prototype.toparamsarray=function(e,r){var i=this;void 0===r&&(r="");var n="";return Array.isArray(e)||s.isObject(e)?m.forEach(e,function(e,t){n+=i.toparamsarray(e,r+"["+t+"]")}):n+=r+"="+e,n},e.prototype.toparams=function(e){var r=this,i="";return m.forEach(e,function(e,t){i+=r.toparamsarray(e,"&"+t)}),i.slice(1)},e}(),H=function(){function e(e){this.localfilterparams=e||{}}return e.prototype.passFilter=function(e,t){for(var r in t){if(!("object"==typeof e&&"attributes"in e))return!0;if("object"==typeof t[r])return t[r].test(e.attributes[r]);if("string"==typeof e.attributes[r])return e.attributes[r]===t[r]}return!1},e.prototype.filterCollection=function(e,r){var i=this;Object.keys(this.localfilterparams).length&&m.forEach(e,function(e,t){i.passFilter(e,i.localfilterparams)&&(r[t]=e)})},e}(),k=function(){function e(){}return e.resourceToResource=function(e,t){for(var r in t.attributes=e.attributes,t.relationships)if(r in e.relationships){if(!("id"in t.relationships[r].data))for(var i in t.relationships[r].data)i in e.relationships[r].data||delete t.relationships[r]}else delete t.relationships[r];for(var r in e.relationships)"id"in e.relationships[r].data?t.addRelationship(e.relationships[r].data,r):t.addRelationships(e.relationships[r].data,r)},e}(),D=function(){function e(){this.collections={},this.collections_lastupdate={},this.resources={}}return e.prototype.isCollectionExist=function(e){return e in this.collections&&"new"!==this.collections[e].$source},e.prototype.isCollectionLive=function(e,t){return Date.now()<=this.collections_lastupdate[e]+1e3*t},e.prototype.isResourceLive=function(e,t){return this.resources[e]&&Date.now()<=this.resources[e].lastupdate+1e3*t},e.prototype.getOrCreateCollection=function(e){return e in this.collections||(this.collections[e]=m.newCollection(),this.collections[e].$source="new"),this.collections[e]},e.prototype.setCollection=function(r,i){var n=this;this.collections[r]=m.newCollection(),Object.keys(i).forEach(function(e){var t=i[e];n.collections[r][e]=t,n.setResource(t)}),this.collections[r].page=i.page,this.collections_lastupdate[r]=Date.now()},e.prototype.getOrCreateResource=function(e,t){if(A.getService(e).cachememory&&t in A.getService(e).cachememory.resources)return A.getService(e).cachememory.resources[t];var r=A.getService(e).new();return r.id=t,this.setResource(r,!1),r},e.prototype.setResource=function(e,t){void 0===t&&(t=!1),e.id in this.resources?k.resourceToResource(e,this.resources[e.id]):this.resources[e.id]=e,this.resources[e.id].lastupdate=t?Date.now():0},e.prototype.deprecateCollections=function(e){var r=this;return m.forEach(this.collections_lastupdate,function(e,t){r.collections_lastupdate[t]=0}),!0},e.prototype.removeResource=function(r){m.forEach(this.collections,function(e,t){delete e[r]}),this.resources[r].attributes={},this.resources[r].relationships={},delete this.resources[r]},e}(),$=function(o,s,a,c){return new(a||(a=Promise))(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},T=function(){function e(){}return e.prototype.getResource=function(o,s){return void 0===s&&(s=[]),$(this,void 0,void 0,function(){var n=this;return v(this,function(e){return[2,new Promise(function(t,r){R.injectedServices.JsonapiStoreService.getObjet(o.type+"."+o.id).then(function(e){A.build({data:e},o);var i=[];m.forEach(s,function(e){if(e in o.relationships){var t=o.relationships[e].data;if(!("attributes"in t)){var r=n.getResourceFromMemory(t);r.is_new?i.push(n.getResource(r)):console.warn("ts-angular-json: esto no debería pasar #isdjf2l1a"),o.relationships[e].data=r}}}),o.lastupdate=e._lastupdate_time,0===i.length?t(e):Promise.all(i).then(function(e){t(e)}).catch(function(e){r(e)})}).catch(function(){r()})})]})})},e.prototype.setResource=function(e){R.injectedServices.JsonapiStoreService.saveObject(e.type+"."+e.id,e.toObject().data)},e.prototype.getCollectionFromStorePromise=function(i,n,o){return $(this,void 0,void 0,function(){var r=this;return v(this,function(e){return[2,new Promise(function(e,t){r.getCollectionFromStore(i,n,o,e,t)})]})})},e.prototype.getCollectionFromStore=function(e,t,r,i,n){var o=this;R.injectedServices.JsonapiStoreService.getObjet("collection."+e).then(function(e){if(o.fillCollectionWithArrrayAndResourcesOnMemory(e.data,r))return r.$source="store",r.$cache_last_update=e._lastupdate_time,void i(r);o.fillCollectionWithArrrayAndResourcesOnStore(e,t,r).then(function(){if("new"!==r.$source)throw console.warn("ts-angular-json: esto no debería pasar. buscar eEa2ASd2#"),new Error("ts-angular-json: esto no debería pasar. buscar eEa2ASd2#");r.$source="store",r.$cache_last_update=e._lastupdate_time,i(r)}).catch(function(){n()})}).catch(function(){n()})},e.prototype.fillCollectionWithArrrayAndResourcesOnMemory=function(e,t){var r=!0;for(var i in e){var n=e[i],o=this.getResourceFromMemory(n);if(o.is_new){r=!1;break}t[n.id]=o}return r},e.prototype.getResourceFromMemory=function(e){return A.getService(e.type).cachememory.getOrCreateResource(e.type,e.id)},e.prototype.fillCollectionWithArrrayAndResourcesOnStore=function(c,u,l){return $(this,void 0,void 0,function(){var a=this;return v(this,function(e){return[2,new Promise(function(i,t){var n={},e=[];for(var r in c.data){var o=c.data[r],s=A.getService(o.type).cachememory;n[o.id]=s.getOrCreateResource(o.type,o.id),e.push(a.getResource(n[o.id],u))}Promise.all(e).then(function(e){for(var t in c.page&&(l.page=c.page),n){var r=n[t];l[r.id]=r}i(l)}).catch(function(e){t(e)})})]})})},e.prototype.setCollection=function(e,t,r){var n=this,o={data:{},page:{}},s={};m.forEach(t,function(i){n.setResource(i),o.data[i.id]={id:i.id,type:i.type},m.forEach(r,function(t){if("id"in i.relationships[t].data){var e=i.relationships[t].data;s[t+e.id]=e}else{var r=i.relationships[t].data;m.forEach(r,function(e){s[t+e.id]=e})}})}),o.page=t.page,R.injectedServices.JsonapiStoreService.saveObject("collection."+e,o),m.forEach(s,function(e){"is_new"in e?n.setResource(e):console.warn("No se pudo guardar en la cache el",e.type,"por no se ser Resource.",e)})},e.prototype.deprecateCollections=function(e){return R.injectedServices.JsonapiStoreService.deprecateObjectsWithKey("collection."+e),!0},e}(),q=function(r){function e(){var e=r.call(this)||this;return e.resource=I,e.smartfiltertype="undefined",e.register(),e}return d(e,r),e.prototype.register=function(){if(null===R.me)throw new Error("Error: you are trying register `"+this.type+"` before inject JsonapiCore somewhere, almost one time.");return this.cachememory=new D,this.cachestore=new T,this.schema=Object.assign({},m.Schema,this.schema),R.me.registerService(this)},e.prototype.newResource=function(){return new this.resource},e.prototype.new=function(){var e=this.newResource();return e.type=this.type,this.getService(),e.reset(),e},e.prototype.getPrePath=function(){return""},e.prototype.getPath=function(){return this.path?this.path:this.type},e.prototype.get=function(e,t,r,i){return this.__exec({id:e,params:t,fc_success:r,fc_error:i,exec_type:"get"})},e.prototype.delete=function(e,t,r,i){return this.__exec({id:e,params:t,fc_success:r,fc_error:i,exec_type:"delete"})},e.prototype.all=function(e,t,r){return this.__exec({id:null,params:e,fc_success:t,fc_error:r,exec_type:"all"})},e.prototype.__exec=function(e){var t=r.prototype.proccess_exec_params.call(this,e);switch(t.exec_type){case"get":return this._get(t.id,t.params,t.fc_success,t.fc_error);case"delete":return this._delete(t.id,t.params,t.fc_success,t.fc_error);case"all":return this._all(t.params,t.fc_success,t.fc_error)}},e.prototype._get=function(e,t,r,i){var n=this,o=new E;o.applyParams(this,t),o.appendPath(e);var s=this.getService().cachememory.getOrCreateResource(this.type,e);s.is_loading=!0;var a=new f.BehaviorSubject(s),c=t.ttl||0;if(this.getService().cachememory.isResourceLive(e,c)){var u=new Promise(function(e,t){e(r),u.then(function(e){console.warn("ngx-jsonapi: THIS CODE NEVER RUN, RIGHT? :/ Please check."),a.next(s),n.runFc(e,"cachememory")}).catch(h.noop),s.is_loading=!1});return a.next(s),a.complete(),a.asObservable()}return R.injectedServices.rsJsonapiConfig.cachestore_support?this.getService().cachestore.getResource(s).then(function(e){m.isObjectLive(c,s.lastupdate)?(a.next(s),n.runFc(r,{data:e})):n.getGetFromServer(o,r,i,s,a)}).catch(function(e){n.getGetFromServer(o,r,i,s,a)}):this.getGetFromServer(o,r,i,s,a),a.next(s),a.asObservable()},e.prototype.getGetFromServer=function(e,t,r,i,n){var o=this;R.injectedServices.JsonapiHttp.get(e.get()).then(function(e){A.build(e,i),i.is_loading=!1,o.getService().cachememory.setResource(i),R.injectedServices.rsJsonapiConfig.cachestore_support&&o.getService().cachestore.setResource(i),n.next(i),n.complete(),o.runFc(t,e)}).catch(function(e){n.error(e),o.runFc(r,e)})},e.prototype._all=function(t,r,i){var n=this;t.smartfilter&&"localfilter"!==this.smartfiltertype&&Object.assign(t.remotefilter,t.smartfilter),t.cachehash=t.cachehash||"";var o=new E,e=new M;o.applyParams(this,t),t.remotefilter&&0<Object.keys(t.remotefilter).length&&(this.getService().parseToServer&&this.getService().parseToServer(t.remotefilter),o.addParam(e.toparams({filter:t.remotefilter}))),t.page&&(1<t.page.number&&o.addParam(R.injectedServices.rsJsonapiConfig.parameters.page.number+"="+t.page.number),t.page.size&&o.addParam(R.injectedServices.rsJsonapiConfig.parameters.page.size+"="+t.page.size));var s,a=this.getService().cachememory.getOrCreateCollection(o.getForCache()),c=new H(t.localfilter);s=t.localfilter&&0<Object.keys(t.localfilter).length?m.newCollection():a;var u=new f.BehaviorSubject(s),l=t.ttl||this.schema.ttl;if(0<=l&&this.getService().cachememory.isCollectionExist(o.getForCache()))if(a.$source="memory",t.smartfilter&&"localfilter"===this.smartfiltertype&&Object.assign(t.localfilter,t.smartfilter),c.filterCollection(a,s),this.getService().cachememory.isCollectionLive(o.getForCache(),l))var p=new Promise(function(e,t){e(r),p.then(function(e){u.next(a),n.runFc(e,"cachememory")}).catch(h.noop)});else this.getAllFromServer(o,t,r,i,a,s,u);else R.injectedServices.rsJsonapiConfig.cachestore_support?(a.$is_loading=!0,this.getService().cachestore.getCollectionFromStorePromise(o.getForCache(),o.includes,a).then(function(e){a.$source="store",a.$is_loading=!1,n.getService().cachememory.setCollection(o.getForCache(),a),c.filterCollection(a,s),m.isObjectLive(l,a.$cache_last_update)?(u.next(a),n.runFc(r,{data:e})):n.getAllFromServer(o,t,r,i,a,s,u)}).catch(function(e){n.getAllFromServer(o,t,r,i,a,s,u)})):(a.$is_loading=!0,this.getAllFromServer(o,t,r,i,a,s,u));return u.next(s),u.asObservable()},e.prototype.getAllFromServer=function(r,i,n,t,o,s,a){var c=this;o.$is_loading=!0,R.injectedServices.JsonapiHttp.get(r.get()).then(function(e){if(o.$source="server",o.$is_loading=!1,i.cachehash&&m.forEach(e.data,function(e){e.id=e.id+i.cachehash}),A.build(e,o),c.getService().cachememory.setCollection(r.getForCache(),o),R.injectedServices.rsJsonapiConfig.cachestore_support&&c.getService().cachestore.setCollection(r.getForCache(),o,i.include),new H(i.localfilter).filterCollection(o,s),"undefined"===c.smartfiltertype){var t=o.page;1===t.number&&t.total_resources<=t.resources_per_page?c.smartfiltertype="localfilter":1===t.number&&t.total_resources>t.resources_per_page&&(c.smartfiltertype="remotefilter")}a.next(o),a.complete(),c.runFc(n,e)}).catch(function(e){o.$is_loading=!1,a.next(o),a.error(e),c.runFc(t,e)})},e.prototype._delete=function(t,e,r,i){var n=this,o=new E;o.applyParams(this,e),o.appendPath(t);var s=new a.Subject;return R.injectedServices.JsonapiHttp.delete(o.get()).then(function(e){n.getService().cachememory.removeResource(t),s.next(),s.complete(),n.runFc(r,e)}).catch(function(e){s.error(e),n.runFc(i,e)}),s.asObservable()},e.prototype.getService=function(){return A.getService(this.type)||this.register()},e.prototype.clearCacheMemory=function(){var e=new E;return e.applyParams(this),this.getService().cachememory.deprecateCollections(e.getForCache())&&this.getService().cachestore.deprecateCollections(e.getForCache())},e.prototype.parseToServer=function(e){},e.prototype.parseFromServer=function(e){},e}(P);e.Autoregister=function(){return function(e){var i=e,t=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=i.apply(this,e);return r.register(),r};return t.prototype=i.prototype,t}},e.JsonapiCore=R,e.Resource=I,e.Service=q,e.NgxJsonapiModule=x,e.ɵa=g,e.ɵe=P,e.ɵd=S,e.ɵc=w,e.ɵb=O,Object.defineProperty(e,"__esModule",{value:!0})});